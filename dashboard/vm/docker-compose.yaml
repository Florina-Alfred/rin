version: '3.7'

services:
  # VictoriaMetrics as Prometheus replacement
  victoriametrics:
    image: victoriametrics/vmstorage:latest
    container_name: victoriametrics
    ports:
      - "8428:8428" # VictoriaMetrics API
    volumes:
      - ./victoriametrics-data:/victoria-metrics-data
    restart: always
    networks:
      - observability

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: 'admin' # set a password
    ports:
      - "3000:3000" # Grafana UI
    depends_on:
      - victoriametrics
      - loki
      - tempo
    networks:
      - observability
    restart: always

  # Loki
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    volumes:
      - ./loki-data:/loki/data
    restart: always
    networks:
      - observability

  # Tempo
  tempo:
    image: grafana/tempo:latest
    container_name: tempo
    ports:
      - "3200:3200"
    restart: always
    networks:
      - observability

  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector
    container_name: otel-collector
    environment:
      - OTEL_RESOURCE_ATTRIBUTES=service.name=my-otel-collector
    ports:
      - "4317:4317" # OTLP gRPC
      - "55680:55680" # OTLP HTTP
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    command: ["--config", "/etc/otel-collector-config.yaml"]
    restart: always
    networks:
      - observability

volumes:
  victoriametrics-data:
  loki-data:

networks:
  observability:
    driver: bridge

